<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My alcohol consumption</title>
<link rel="stylesheet" href="http://demos.jquerymobile.com/1.4.4/css/themes/default/jquery.mobile-1.4.4.min.css">
<link rel="stylesheet" href="http://demos.jquerymobile.com/1.4.4/_assets/css/jqm-demos.css">
<link rel="shortcut icon" href="http://demos.jquerymobile.com/1.4.4/favicon.ico">
<script src="http://demos.jquerymobile.com/1.4.4/js/jquery.js"></script>
<script src="http://demos.jquerymobile.com/1.4.4/_assets/js/index.js"></script>
<script src="http://demos.jquerymobile.com/1.4.4/js/jquery.mobile-1.4.4.min.js"></script>

<!-- polyfill indexeddb -> websql adapter ftw! -->
<script src="https://raw.github.com/axemclion/IndexedDBShim/master/dist/IndexedDBShim.min.js"></script>

<style type="text/css">
.red {color:red;}
</style>

<script type="text/javascript">

String.format = function() {
  var s = arguments[0];
  for (var i = 0; i < arguments.length - 1; i++) {       
    var reg = new RegExp("\\{" + i + "\\}", "gm");             
    s = s.replace(reg, arguments[i + 1]);
  }
  return s;
}

var myns = {};
myns.ui = {};
myns.db = {};
myns.db.db = null;
myns.db.onerror = function(e) { console.log(e); };


const DB_NAME = "drinks_dev_1";
const STORE_NAME_DRINKS = "drink";
const STORE_NAME_SERVINGS = "serving";
const STORE_NAME_CONSUMPTIONS = "consumption";
const ALL_STORES = [ STORE_NAME_DRINKS, STORE_NAME_SERVINGS, STORE_NAME_CONSUMPTIONS ];
const RO = "readonly";
const RW = "readwrite";



myns.db.onopenfinished = null;
myns.db.open = function() {
    var version = 18;
    var request = indexedDB.open(DB_NAME, version);

    // We can only create Object stores in a versionchange transaction.
    request.onupgradeneeded = function(e) {
        var db = e.target.result;

        // A versionchange transaction is started automatically.
        e.target.transaction.onerror = myns.db.onerror;

        ALL_STORES.forEach( function(store) {
            if(db.objectStoreNames.contains(store)) { db.deleteObjectStore(store); }
            });



        var inserter;
        var store_servings = db.createObjectStore(STORE_NAME_SERVINGS, {keyPath: "name"});
        var store_drinks = db.createObjectStore(STORE_NAME_DRINKS, {keyPath: "name"});
        var store_consumptions = db.createObjectStore(STORE_NAME_CONSUMPTIONS, {keyPath: "date"});

        var get_inserter = function(store) {
            return function(data) { 
                var request = store.put(data);
                //request.onerror = function(e)  { console.log(e); };
            }
        }

        inserter = get_inserter(store_servings);
        inserter({name:"Halbe", liter: 0.5});
        inserter({name:"Seiterl", liter: 0.3});
        inserter({name:"1/4erl", liter: 0.25});
        inserter({name:"1/8erl", liter: 0.125});
        inserter({name:"2cl", liter: 0.02});
        inserter({name:"4cl", liter: 0.04});
        inserter({name:"Flasche (0.75)", liter: 0.75});
        
        inserter = get_inserter(store_drinks);
        inserter({name:"Bier", calories:100, alc:5, servings:["Halbe", "Seiterl"]});
        inserter({name:"Wein", calories:100, alc:9, servings:["1/8erl"]});
        inserter({name:"Spritzer", calories: 100, alc:4, servings:["1/4erl", "Halbe"]});
        inserter({name:"Sekt", calories: 100, alc:4, servings:["1/8erl", "Flasche (0.75)"]});

        inserter = get_inserter(store_consumptions);
        inserter( {date:new Date(2014, 5, 4), 
            drinks: [ 
            {drink: "Bier", amount: 3, servings:"Halbe"}, 
            {drink: "Wein", amount: 1, servings: "1/8erl"} 
            ], 
            tags:["fun"]});

        inserter( {date:new Date(2013, 12-1, 31), 
            drinks: [ 
            {drink: "Bier", amount: 30, servings:"Halbe"}, 
            {drink: "Sekt", amount: 15, servings: "Flasche (0.75)"} 
            ], 
            tags:["puke"]});
    };

    request.onsuccess = function(e) {

        myns.db.db = e.target.result;

        if (myns.db.onopenfinished != null) {
            myns.db.onopenfinished();
        }
    };

    request.onerror = myns.db.onerror;
};

function has_value(v) {
    console.assert(v !== undefined && v != null);
}


myns.db.insert = function(store_name, data, oncomplete) {
    var trans = myns.db.db.transaction([store_name], RW);
    var store = trans.objectStore(store_name);
    var request = store.put(data);
    trans.oncomplete = function(e) { oncomplete(); };
    request.onerror = function(e) { console.log(e.value); };
}

myns.db.fetchAll = function(store_name, onresult) {
    var trans = myns.db.db.transaction([store_name], RO);
    var store = trans.objectStore(store_name);

    // Get everything in the store;
    var keyRange = IDBKeyRange.lowerBound(0);
    var cursorRequest = store.openCursor(keyRange);

    cursorRequest.onsuccess = function(e) {
        var result = e.target.result;
        if(!!result == false)
          return;

        onresult(result.value);

        // safari: parser error, reserved keyword 'continue'
        result['continue']();
    };

    trans.onerror = myns.db.onerror;
    cursorRequest.onerror = myns.db.onerror;
}

myns.db.addDrink = function(drinkname) {
    myns.db.insert(STORE_NAME_DRINKS, {
        "name": drinkname,
        "timestamp" : new date()
        }, function(){});
};

myns.db.addConsumption = function(date, drinks) {
    myns.db.insert(STORE_NAME_CONSUMPTIONS, {
        "date": date, "drinks": drinks
        }, function() {});
};


function addDrink() {
    var drink = $('#add-drink-name');
    myns.db.addDrink(drink.val());
    drink.val('');
}

function addConsumption() {

    var fs = $('#consume-entries fieldset');

    var drinks = [];
    fs.each(function(idx, elem) {
        drinks.push( {
          "amount":$( this ).find ('select[name="amount"]').val(),
          "drink":$( this ).find ('select[name="drink"]').val(),
          "servings":$( this ).find ('select[name="serving"]').val()
          });
        });
    myns.db.addConsumption(
        new Date($('#consume-date').val()),
        drinks
        );


}


function formatDate(date) {
    var day = ("0" + date.getDate()).slice(-2);
    var month = ("0" + (date.getMonth() + 1)).slice(-2);

    return date.getFullYear()+"-"+(month)+"-"+(day) ;
}


function addConsumptionEntry() {

    var div = $('#consume-entries');

    var fs = $('<fieldset data-role="controlgroup" data-type="horizontal"></fieldset>');
    div.append(fs);

    var select_amount = $('<select name="amount" id="consume-amount1">');
    var select_serv = $('<select name="serving">');
    var select_drink = $('<select name="drink">');


    for (i = 1; i <= 20; i++) {
        select_amount.append('<option value="' + i + '">' + i + '</option>');
    }

    select_serv.append( $( '<option value=""></option>' ) );
    myns.db.fetchAll(STORE_NAME_SERVINGS, function(serv) {
        select_serv.append( $( String.format('<option value="{0}">{0}</option>', serv.name) ) );
        });

    select_drink.append( $( '<option value=""></option>' ) );
    myns.db.fetchAll(STORE_NAME_DRINKS, function(drink) {
        select_drink.append( $( String.format('<option value="{0}">{0}</option>', drink.name) ) );
        });

    var delete_entry = $('<button data-inline="true">x</button>');
    delete_entry.on('click', function() { fs.remove(); });

    fs.append(select_amount).trigger('create');
    fs.append(select_serv).trigger('create');
    fs.append(select_drink).trigger('create');
    fs.append(delete_entry).trigger('create');
    div.append(fs).trigger('create');
}

function onPageAddConsumption() {

    var input_date = $('#consume-date');
    input_date.val(formatDate(new Date()));

    addConsumptionEntry();
}

function onPageOne() {
    var target_ul = $('#consumption-list');
    target_ul.empty();

    myns.db.fetchAll(STORE_NAME_CONSUMPTIONS, function(value) {
        target_ul.append(
          $(String.format('<li><a href="#" class="ui-btn ui-btn-icon-right ui-icon-carat-r">{0}: {1}</a></li>',
              value.date.toDateString(),
              value.drinks
              .map(function(drink) {return String.format("{0} {1} {2}", drink.amount, drink.servings, drink.drink); })
              .join(', ')
              ))
          );
        });
}

function onPageDrinks() {
    var target_ul = $('#drink-list');
    target_ul.empty();

    myns.db.fetchAll(STORE_NAME_DRINKS, function(value) {
        target_ul.append($('<li><a href="#" class="ui-btn ui-btn-icon-right ui-icon-carat-r">'+value.name+'</a></li>'));
        });
}


function onPageServings() {
    var target_ul = $('#serving-list');
    target_ul.empty();

    myns.db.fetchAll(STORE_NAME_SERVINGS, function(value) {
        target_ul.append(
          $(String.format('<li><a href="#" class="ui-btn ui-btn-icon-right ui-icon-carat-r">{0} -- {1}l</a></li>', 
              value.name, 
              value.liter))
          );
        });
}


function onDbOpen() {
    onPageOne();
}

$(function() {

    myns.db.onopenfinished = onDbOpen;

    myns.db.open();
    $('#add-drink-btn').click(function() { addDrink(); });
    $('#add-consumption-btn').click(addConsumption);
    $('#btn-add-consumption-entry').click(addConsumptionEntry);

    $('#page-one').on("pagebeforeshow", onPageOne);
    $('#page-one').on("pagehide", function() { $('#consumption-list').empty()});
    $('#page-drinks').on("pagebeforeshow", onPageDrinks);
    $('#page-drinks').on("pagehide", function() { $('#drink-list').empty() });
    $('#page-servings').on("pagebeforeshow", onPageServings);
    $('#page-servings').on("pagehide", function() { $('#serving-list').empty() });
    $('#page-add-consumption').on("pageshow", onPageAddConsumption);
    $('#page-add-consumption').on("pagehide", function() { $('#consume-entries').empty() });
    });



</script>

</head>
<body>

<!-- Start of first page: #one -->
<div data-role="page" id="page-one">

  <div data-role="header">
    <h1>My alcohol consumption</h1>
  </div><!-- /header -->

  <div role="main" class="ui-content">
    <h2>Overview</h2>
    <ul id="consumption-list" data-role="listview" data-filter="true" data-inset="true"></ul>

    <a href="#page-add-consumption" class="ui-btn ui-shadow ui-corner-all">Add consumption</a>
    <a href="#page-drinks" class="ui-btn ui-shadow ui-corner-all">Show drinks</a>
    <a href="#page-servings" class="ui-btn ui-shadow ui-corner-all">Show servings</a>
  </div>

  <!--div data-role="footer" data-theme="a">
    <h4>Page Footer</h4>
  </div-->
</div>



<div data-role="page" id="page-add-consumption">
  <div data-role="header">
    <h1>I consumed</h1>
  </div>

  <div role="main" class="ui-content">
    <form name="consumption" id="consumption-form">
      <input name="date" id="consume-date" type="date">
      <div id="consume-entries">
      </div>
      <datalist id="tags"></datalist>
    </form>

    <button id="btn-add-consumption-entry">More!</button>

    <a href="#page-one" id="add-consumption-btn" data-rel="back" class="ui-btn ui-shadow ui-corner-all ui-btn-inline ui-icon-plus ui-btn-icon-left">Add</a>
    <a href="#page-one" data-rel="back" class="ui-btn ui-shadow ui-corner-all ui-btn-inline ui-icon-back ui-btn-icon-left">Cancel</a>
  </div>
</div>


<div data-role="page" id="page-drinks" data-theme="a">

  <div data-role="header">
    <h1>Drinks</h1>
  </div>

  <div role="main" class="ui-content">
    <h2>Drinks</h2>

    <ul id="drink-list" data-role="listview" data-filter="true" data-inset="true"></ul>

    <!--p><a href="#page-add-drink" class="ui-btn ui-shadow ui-corner-all" data-rel="dialog" data-transition="pop">add drink</a></p-->
    <p><a href="#page-one" data-direction="reverse" class="ui-btn ui-shadow ui-corner-all ui-btn-b ui-icon-back ui-btn-icon-left">Back</a></p>
  </div>

  <!--div data-role="footer">
    <h4>Page Footer</h4>
  </div-->
</div>

<div data-role="page" id="page-servings" data-theme="a">

  <div data-role="header">
    <h1>Servings</h1>
  </div>

  <div role="main" class="ui-content">
    <h2>Servings</h2>

    <ul id="serving-list" data-role="listview" data-filter="true" data-inset="true"></ul>

    <a href="#page-one" data-direction="reverse" class="ui-btn ui-shadow ui-corner-all ui-btn-b ui-icon-back ui-btn-icon-left">Back</a>
  </div>

  <!--div data-role="footer">
    <h4>Page Footer</h4>
  </div-->
</div>



<div data-role="page" id="page-add-drink">

  <div data-role="header" data-theme="b">
    <h1>Add drink</h1>
  </div>

  <div role="main" class="ui-content">
    <form>
      <label for="add-drink-name">New drink:</label>
      <input id="add-drink-name" data-clear-btn="true" name="add-drink-name" id="text-3" value="" type="text">
    </form>

    <a href="#page-drinks" id="add-drink-btn" data-rel="back" class="ui-btn ui-shadow ui-corner-all ui-btn-inline ui-icon-plus ui-btn-icon-left">Add</a>
    <a href="#page-drinks" data-rel="back" class="ui-btn ui-shadow ui-corner-all ui-btn-inline ui-icon-back ui-btn-icon-left">Cancel</a>
  </div>

  <!--div data-role="footer">
    <h4>Page Footer</h4>
  </div-->
</div>

</body>
</html>

